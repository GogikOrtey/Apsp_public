10.12.2025 04:10:49




--------------------------------------------------------------------------------------------------

                                        GLOBAL CODE GEN

--------------------------------------------------------------------------------------------------


field = name, stock, link, price, article, brand, imageLink, timestamp



--------------------------------------------------------------------------------------------------

                                       EXTRACTION SELECTOR

--------------------------------------------------------------------------------------------------


üüß timestamp –Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ, –¥–∞–Ω–Ω—ã–µ –¥–ª—è parsePage –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏
{'page': '2', 'query': '–ö–æ—Ç—ë–ª'}
–ü–∞—Ä–∞–º–µ—Ç—Ä –ø–æ–∏—Å–∫–∞: query
–ü–∞—Ä–∞–º–µ—Ç—Ä –ø–∞–≥–∏–Ω–∞—Ü–∏–∏: page
–û—á–∏—â–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å: {}
search_host = https://glavsantex.ru/search/
host: https://glavsantex.ru
path: /search/

–ù–∞–π–¥–µ–Ω–æ 6 –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤

product_selector = a.item-c__title.js-item__title[href]
len_of_products_on_this_page = 30
–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ = 1.00 (3/3)
–ò–∑–≤–ª–µ–∫–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª-–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü

–ù–∞–π–¥–µ–Ω–æ 172 –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
pagination_selctor = ul.pagination__list > li:nth-of-type(6) > a
–ü—Ä–æ–≤–µ—Ä–∏–ª–∏, –∏ –Ω–∞—à–ª–∏ —Ç–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É —Å–µ–ª–µ–∫—Ç–æ—Ä—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏: 14
result_pagination_block = 

let totalPages = Math.max(...$("ul.pagination__list > li:nth-of-type(6) > a").get().map(item => +$(item).text().trim()).filter(Boolean))

    async parsePage(set: SetType) {
        let url = new URL(`${HOST}/search/`)
        url.searchParams.set("query", set.query)
        url.searchParams.set("page", set.page)
        
        const data = await this.makeRequest(url.href)
        const $ = cheerio.load(data)

        if (set.page === 1) {
            let totalPages = Math.max(...$("ul.pagination__list > li:nth-of-type(6) > a").get().map(item => +$(item).text().trim()).filter(Boolean))
            this.debugger.put(`totalPages = ${totalPages}`)
            for (let page = 2; page <= Math.min(totalPages, +this.conf.pagesCount); page++) {
                this.query.add({ ...set, query: set.query, type: "page", page: page, lvl: 1 });
            }
        }
        
        let products = $("a.item-c__title.js-item__title[href]")
        if (products.length == 0) {
            this.logger.put(`–ü–æ –∑–∞–ø—Ä–æ—Å—É ${set.query} –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`)
            throw new NotFoundError()
        }
        products.slice(0, +this.conf.itemsCount).each((i, product) => {
            let link = `${HOST}${$(product)?.attr("href")}`
            this.query.add({ ...set, query: link, type: "card", lvl: 1 })
        }) 
    }
    
–ò–º—è –ø–∞—Ä—Å–µ—Ä–∞: JS_Base_glavsantexru



--------------------------------------------------------------------------------------------------

                                    FINAL RESULT PARSER CODE

--------------------------------------------------------------------------------------------------


import { getDefaultConf, defaultEditableConf, defaultOpts, getCacher } from "../Base-Custom/Constants";
import { AsyncHTTPXRequestOptsCustom, defaultConf, editableConf, Item } from "../Base-Custom/Types";
import { InvalidLinkError, NotFoundError } from "../Base-Custom/Errors";
import { JS_Base_Custom } from "../Base-Custom/Base-Custom";
import { getTimestamp } from "../Base-Custom/Utils";
import { SetType, tools } from "a-parser-types";
import { Cacher } from "../Base-Custom/Cache";
import {
    toArray, isBadLink,
    name, stock, link, price, article, brand, imageLink, timestamp
} from "../Base-Custom/Fields"
import * as cheerio from "cheerio";

//#region –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
type ResultItem = Item<typeof fields>

//#region –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const fields = {
    name, stock, link, price, article, brand, imageLink, timestamp
}

const HOST = "https://glavsantex.ru"

export class JS_Base_glavsantexru extends JS_Base_Custom {
    static defaultConf: defaultConf = {
            ...getDefaultConf(toArray(fields), "Œ∂", [isBadLink]),
            parsecodes: { 200: 1, 404: 1 },
            proxyChecker: "tor.proxy.ru",
            requestdelay: "3,5",
            engine: "a-parser",
            mode: "normal",
        };

    static editableConf: editableConf = [
        ...defaultEditableConf
    ];

    //#region –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
    async parse(set: SetType, results: { [key: string]: any }) {
        if (!set.type || set.type === "none") set.type = "page";
        if (!set.region || set.region === "none") set.region = "";
        try {
            switch (set.type) {
                case "page": {
                    if (!set.page || set.page === "none") set.page = 1;
                    await this.parsePage(set);
                    results.success = 1;
                    break;
                }
                case "card": {
                    const cacher = getCacher<ResultItem>(this, set)
                    let items = cacher.cache || await this.parseCard(set, cacher);
                    items.forEach(item => results.items.addElement(item));
                    results.success = 1;
                    break;
                }
                default:
                    this.logger.put("–£–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–±–æ—Ä–∞")
                    results.success = 0;
            }
        } catch (e: any) {
            if (e instanceof NotFoundError || e instanceof InvalidLinkError) {
                this.logger.put(e.message);
                results.isBadLink = 1;
                results.success = 1;
            } else {
                this.logger.put(`${e.name} >> ${e.message}   ${set.query}  type - ${set.type} page ${set.page} }`);
                results.success = 0;
            }
        }
        return results;
    }

    //#region –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–∏—Å–∫–∞
    
    async parsePage(set: SetType) {
        let url = new URL(`${HOST}/search/`)
        url.searchParams.set("query", set.query)
        url.searchParams.set("page", set.page)
        
        const data = await this.makeRequest(url.href)
        const $ = cheerio.load(data)

        if (set.page === 1) {
            let totalPages = Math.max(...$("ul.pagination__list > li:nth-of-type(6) > a").get().map(item => +$(item).text().trim()).filter(Boolean))
            this.debugger.put(`totalPages = ${totalPages}`)
            for (let page = 2; page <= Math.min(totalPages, +this.conf.pagesCount); page++) {
                this.query.add({ ...set, query: set.query, type: "page", page: page, lvl: 1 });
            }
        }
        
        let products = $("a.item-c__title.js-item__title[href]")
        if (products.length == 0) {
            this.logger.put(`–ü–æ –∑–∞–ø—Ä–æ—Å—É ${set.query} –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`)
            throw new NotFoundError()
        }
        products.slice(0, +this.conf.itemsCount).each((i, product) => {
            let link = `${HOST}${$(product)?.attr("href")}`
            this.query.add({ ...set, query: link, type: "card", lvl: 1 })
        }) 
    }
    

    //#region –ü–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞
    

    //#region –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    async makeRequest(url: string) {
        const opts: AsyncHTTPXRequestOptsCustom = {
            ...defaultOpts,
            engine: this.conf.engine,
            mode: this.conf.mode,
        };
        this.debugger.put(opts)

        const { success, headers, data } = await this.request("GET", url, {}, opts);
        this.debugger.put(data)

        if (!success || typeof data !== "string") throw new Error("–ù–µ—É–¥–∞—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å");
        if (headers.Status === 404) throw new NotFoundError();

        return data;
    }
}

// –ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω APSP v0.1
// –î–∞—Ç–∞: 10 –î–µ–∫ 2025
// ¬© BrandPol
